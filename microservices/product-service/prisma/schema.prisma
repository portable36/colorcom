// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Tenant {
  id        String   @id @default(cuid())
  name      String
  slug      String   @unique
  logo      String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  products Product[]

  @@index([slug])
}

model Product {
  id       String @id @default(cuid())
  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  // Core product info
  sku             String
  name            String
  description     String
  longDescription String?
  category        String
  subCategory     String?
  tags            String[] @default([])

  // Pricing & inventory
  price           Float
  costPrice       Float?
  discountPrice   Float?
  discountPercent Float?
  stock           Int    @default(0)
  reserved        Int    @default(0)

  // Product details
  weight     Float?
  dimensions Json?
  images     String[] @default([])
  thumbnail  String?

  // SEO & marketing
  seoTitle       String?
  seoDescription String?
  seoKeywords    String?
  rating         Float?  @default(0)
  reviewCount    Int     @default(0)

  // Status & visibility
  status   ProductStatus @default(ACTIVE)
  featured Boolean       @default(false)
  trending Boolean       @default(false)

  // Metadata
  metadata    Json?
  seoMetadata Json?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relationships
  variants    Variant[]
  categoryRef Category?          @relation(fields: [categoryId], references: [id])
  categoryId  String?
  productTags ProductTag[]
  attributes  ProductAttribute[]

  // Translations for multi-language support
  translations ProductTranslation[]

  @@unique([tenantId, sku])
  @@index([tenantId])
  @@index([category])
  @@index([categoryId])
  @@index([status])
  @@index([createdAt])
  @@index([rating])
}

model ProductTranslation {
  id        String  @id @default(cuid())
  productId String
  product   Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  lang            String // e.g., 'en', 'fr', 'es'
  name            String
  description     String
  longDescription String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([productId, lang])
  @@index([lang])
}

model Variant {
  id        String  @id @default(cuid())
  productId String
  product   Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  // Variant-specific pricing & inventory
  sku           String
  price         Float?
  costPrice     Float?
  discountPrice Float?
  stock         Int    @default(0)
  reserved      Int    @default(0)

  // Variant images
  images String[] @default([])

  // Status
  status VariantStatus @default(ACTIVE)

  // Metadata & tracking
  metadata  Json?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relationships
  options           VariantOption[]
  variantAttributes VariantAttribute[]

  @@unique([productId, sku])
  @@index([productId])
  @@index([status])
  @@index([createdAt])
}

model VariantOption {
  id        String  @id @default(cuid())
  variantId String
  variant   Variant @relation(fields: [variantId], references: [id], onDelete: Cascade)

  // Option key-value (e.g., size: "L", color: "red")
  name  String // e.g., "size", "color", "material"
  value String // e.g., "L", "red", "cotton"

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([variantId, name])
  @@index([variantId])
  @@index([name])
}

enum VariantStatus {
  ACTIVE
  INACTIVE
  OUT_OF_STOCK
}

enum ProductStatus {
  ACTIVE
  INACTIVE
  DRAFT
  ARCHIVED
}

model Category {
  id        String     @id @default(cuid())
  name      String
  slug      String     @unique
  parentId  String?
  parent    Category?  @relation("CategoryParent", fields: [parentId], references: [id])
  children  Category[] @relation("CategoryParent")
  tenantId  String?
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt

  products Product[]

  @@index([slug])
  @@index([tenantId])
}

model Tag {
  id        String   @id @default(cuid())
  name      String
  slug      String   @unique
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  productTags ProductTag[]

  @@index([slug])
}

model ProductTag {
  id        String @id @default(cuid())
  productId String
  tagId     String

  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)
  tag     Tag     @relation(fields: [tagId], references: [id], onDelete: Cascade)

  @@unique([productId, tagId])
  @@index([productId])
  @@index([tagId])
}

model Attribute {
  id        String   @id @default(cuid())
  name      String
  slug      String   @unique
  dataType  String   @default("string") // string|number|boolean|json
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  productAttributes ProductAttribute[]
  variantAttributes VariantAttribute[]

  @@index([slug])
}

model ProductAttribute {
  id          String @id @default(cuid())
  productId   String
  attributeId String
  value       String

  product   Product   @relation(fields: [productId], references: [id], onDelete: Cascade)
  attribute Attribute @relation(fields: [attributeId], references: [id], onDelete: Cascade)

  @@unique([productId, attributeId])
  @@index([productId])
  @@index([attributeId])
}

model VariantAttribute {
  id          String @id @default(cuid())
  variantId   String
  attributeId String
  value       String

  variant   Variant   @relation(fields: [variantId], references: [id], onDelete: Cascade)
  attribute Attribute @relation(fields: [attributeId], references: [id], onDelete: Cascade)

  @@unique([variantId, attributeId])
  @@index([variantId])
  @@index([attributeId])
}
